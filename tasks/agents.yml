---
# Agent installation tasks
# Supports both URL downloads and direct local/network paths

- name: Ensure agents temp directory exists
  ansible.windows.win_file:
    path: "{{ agents_temp_dir }}"
    state: directory
  when: splunk_otel_enabled or nessus_enabled or seeker_enabled

# === Splunk OTEL Collector ===
- name: Download Splunk OTEL installer from URL
  ansible.windows.win_get_url:
    url: "{{ splunk_otel_installer_url }}"
    dest: "{{ agents_temp_dir }}/splunk-otel.msi"
  when:
    - splunk_otel_enabled
    - splunk_otel_installer_url | length > 0
  tags:
    - agents-splunk

- name: Install Splunk OTEL Collector (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/splunk-otel.msi"
    product_id: "{{ splunk_otel_product_id }}"
    arguments: "{{ splunk_otel_install_args }}"
    state: present
  when:
    - splunk_otel_enabled
    - splunk_otel_installer_url | length > 0
  tags:
    - agents-splunk

- name: Install Splunk OTEL Collector (from path)
  ansible.windows.win_package:
    path: "{{ splunk_otel_installer_path }}"
    product_id: "{{ splunk_otel_product_id }}"
    arguments: "{{ splunk_otel_install_args }}"
    state: present
  when:
    - splunk_otel_enabled
    - splunk_otel_installer_path | default('') | length > 0
    - splunk_otel_installer_url | length == 0
  tags:
    - agents-splunk

# === Nessus Agent ===
- name: Download Nessus Agent installer from URL
  ansible.windows.win_get_url:
    url: "{{ nessus_installer_url }}"
    dest: "{{ agents_temp_dir }}/nessus-agent.msi"
  when:
    - nessus_enabled
    - nessus_installer_url | length > 0
  tags:
    - agents-nessus

- name: Install Nessus Agent (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/nessus-agent.msi"
    product_id: "{{ nessus_product_id }}"
    arguments: "{{ nessus_install_args }}"
    state: present
  when:
    - nessus_enabled
    - nessus_installer_url | length > 0
  tags:
    - agents-nessus

- name: Install Nessus Agent (from path)
  ansible.windows.win_package:
    path: "{{ nessus_installer_path }}"
    product_id: "{{ nessus_product_id }}"
    arguments: "{{ nessus_install_args }}"
    state: present
  when:
    - nessus_enabled
    - nessus_installer_path | default('') | length > 0
    - nessus_installer_url | length == 0
  tags:
    - agents-nessus

# === Seeker Agent ===
- name: Download Seeker Agent installer from URL
  ansible.windows.win_get_url:
    url: "{{ seeker_installer_url }}"
    dest: "{{ agents_temp_dir }}/seeker-agent.msi"
  when:
    - seeker_enabled
    - seeker_installer_url | length > 0
  tags:
    - agents-seeker

- name: Install Seeker Agent (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/seeker-agent.msi"
    product_id: "{{ seeker_product_id }}"
    arguments: "{{ seeker_install_args }}"
    state: present
  when:
    - seeker_enabled
    - seeker_installer_url | length > 0
  tags:
    - agents-seeker

- name: Install Seeker Agent (from path)
  ansible.windows.win_package:
    path: "{{ seeker_installer_path }}"
    product_id: "{{ seeker_product_id }}"
    arguments: "{{ seeker_install_args }}"
    state: present
  when:
    - seeker_enabled
    - seeker_installer_path | default('') | length > 0
    - seeker_installer_url | length == 0
  tags:
    - agents-seeker
