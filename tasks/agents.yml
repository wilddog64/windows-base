---
# Agent installation tasks
# Supports both URL downloads and direct local/network paths

- name: Ensure agents temp directory exists
  ansible.windows.win_file:
    path: "{{ agents_temp_dir }}"
    state: directory
  when: splunk_otel_enabled or nessus_enabled or seeker_enabled or splunk_uf_enabled

# === Splunk Universal Forwarder ===
- name: Set Splunk UF Install Arguments
  ansible.builtin.set_fact:
    splunk_uf_final_args: >-
      {{ splunk_uf_install_args }}
      INSTALLDIR="{{ splunk_uf_install_dir }}"
      {% if splunk_uf_indexer_host | length > 0 %}
      RECEIVING_INDEXER="{{ splunk_uf_indexer_host }}:{{ splunk_uf_indexer_port }}"
      {% endif %}
      {% if splunk_uf_deployment_server | length > 0 %}
      DEPLOYMENT_SERVER="{{ splunk_uf_deployment_server }}"
      {% endif %}
  when: splunk_uf_enabled
  tags:
    - agents-splunk-uf

- name: Download Splunk UF installer from URL
  ansible.windows.win_get_url:
    url: "{{ splunk_uf_installer_url }}"
    dest: "{{ agents_temp_dir }}/splunkforwarder.msi"
  when:
    - splunk_uf_enabled
    - splunk_uf_installer_url | length > 0
  tags:
    - agents-splunk-uf

- name: Install Splunk Universal Forwarder (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/splunkforwarder.msi"
    product_id: "{{ splunk_uf_product_id }}"
    arguments: "{{ splunk_uf_final_args }}"
    state: present
  when:
    - splunk_uf_enabled
    - splunk_uf_installer_url | length > 0
  tags:
    - agents-splunk-uf

- name: Install Splunk Universal Forwarder (from path)
  ansible.windows.win_package:
    path: "{{ splunk_uf_installer_path }}"
    product_id: "{{ splunk_uf_product_id }}"
    arguments: "{{ splunk_uf_final_args }}"
    state: present
  when:
    - splunk_uf_enabled
    - splunk_uf_installer_path | default('') | length > 0
    - splunk_uf_installer_url | length == 0
  tags:
    - agents-splunk-uf

# === Splunk OTEL Collector ===
- name: Download Splunk OTEL installer from URL
  ansible.windows.win_get_url:
    url: "{{ splunk_otel_installer_url }}"
    dest: "{{ agents_temp_dir }}/splunk-otel.msi"
  when:
    - splunk_otel_enabled
    - splunk_otel_installer_url | length > 0
  tags:
    - agents-splunk

- name: Install Splunk OTEL Collector (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/splunk-otel.msi"
    product_id: "{{ splunk_otel_product_id }}"
    arguments: "{{ splunk_otel_install_args }}"
    state: present
  when:
    - splunk_otel_enabled
    - splunk_otel_installer_url | length > 0
  tags:
    - agents-splunk

- name: Install Splunk OTEL Collector (from path)
  ansible.windows.win_package:
    path: "{{ splunk_otel_installer_path }}"
    product_id: "{{ splunk_otel_product_id }}"
    arguments: "{{ splunk_otel_install_args }}"
    state: present
  when:
    - splunk_otel_enabled
    - splunk_otel_installer_path | default('') | length > 0
    - splunk_otel_installer_url | length == 0
  tags:
    - agents-splunk

# === Nessus Agent ===
- name: Download Nessus Agent installer from URL
  ansible.windows.win_get_url:
    url: "{{ nessus_installer_url }}"
    dest: "{{ agents_temp_dir }}/nessus-agent.msi"
  when:
    - nessus_enabled
    - nessus_installer_url | length > 0
  tags:
    - agents-nessus

- name: Install Nessus Agent (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/nessus-agent.msi"
    product_id: "{{ nessus_product_id }}"
    arguments: "{{ nessus_install_args }}"
    state: present
  when:
    - nessus_enabled
    - nessus_installer_url | length > 0
  tags:
    - agents-nessus

- name: Install Nessus Agent (from path)
  ansible.windows.win_package:
    path: "{{ nessus_installer_path }}"
    product_id: "{{ nessus_product_id }}"
    arguments: "{{ nessus_install_args }}"
    state: present
  when:
    - nessus_enabled
    - nessus_installer_path | default('') | length > 0
    - nessus_installer_url | length == 0
  tags:
    - agents-nessus

# === Seeker Agent ===
- name: Download Seeker Agent installer from URL
  ansible.windows.win_get_url:
    url: "{{ seeker_installer_url }}"
    dest: "{{ agents_temp_dir }}/seeker-agent.msi"
  when:
    - seeker_enabled
    - seeker_installer_url | length > 0
  tags:
    - agents-seeker

- name: Install Seeker Agent (from URL download)
  ansible.windows.win_package:
    path: "{{ agents_temp_dir }}/seeker-agent.msi"
    product_id: "{{ seeker_product_id }}"
    arguments: "{{ seeker_install_args }}"
    state: present
  when:
    - seeker_enabled
    - seeker_installer_url | length > 0
  tags:
    - agents-seeker

- name: Install Seeker Agent (from path)
  ansible.windows.win_package:
    path: "{{ seeker_installer_path }}"
    product_id: "{{ seeker_product_id }}"
    arguments: "{{ seeker_install_args }}"
    state: present
  when:
    - seeker_enabled
    - seeker_installer_path | default('') | length > 0
    - seeker_installer_url | length == 0
  tags:
    - agents-seeker
